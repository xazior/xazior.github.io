<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma Votazione Nomi - Firebase</title>
    <link href="../fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../design-system.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .voting-container {
            min-height: 100vh;
            padding: 20px;
            background: var(--color-neutral-950);
        }

        .voting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-neutral-800);
        }

        .voting-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .voting-user-badge {
            background: var(--color-primary-purple);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--color-neutral-600);
            color: var(--color-neutral-300);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--color-neutral-800);
            border-color: var(--color-neutral-500);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-neutral-950);
        }

        .login-form {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-800);
            border-radius: var(--radius-2xl);
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }

        .login-form h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-form p {
            color: var(--color-neutral-400);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--color-neutral-300);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-700);
            border-radius: 6px;
            color: white;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-primary-purple);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .login-btn:hover {
            background: #7c3aed;
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--color-neutral-800);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--color-neutral-500);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--color-neutral-300);
        }

        .tab.active {
            color: var(--color-primary-purple);
            border-bottom-color: var(--color-primary-purple);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .proposals-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .proposals-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .proposal-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-800);
            border-radius: var(--radius-xl);
            padding: 20px;
            transition: all 0.2s;
        }

        .proposal-card:hover {
            border-color: var(--color-neutral-700);
            background: rgba(255, 255, 255, 0.08);
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .proposal-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .proposal-score {
            background: var(--color-primary-purple);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 12px;
            white-space: nowrap;
        }

        .proposal-score.negative {
            background: #ef4444;
        }

        .proposal-meta {
            font-size: 12px;
            color: var(--color-neutral-500);
            margin-bottom: 10px;
        }

        .proposal-desc {
            color: var(--color-neutral-300);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .proposal-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 12px;
            background: var(--color-neutral-800);
        }

        .badge-new {
            background: #10b981;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .voting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }

        .vote-btn {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--color-neutral-700);
            background: transparent;
            color: var(--color-neutral-300);
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--color-neutral-600);
        }

        .vote-btn.vote-yes {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #10b981;
        }

        .vote-btn.vote-no {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .vote-btn.vote-ignore {
            background: rgba(107, 114, 128, 0.1);
            border-color: var(--color-neutral-600);
            color: var(--color-neutral-400);
        }

        .top-choice-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-neutral-700);
            background: transparent;
            color: var(--color-neutral-400);
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .top-choice-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .top-choice-btn.active {
            background: #fbbf24;
            border-color: #fbbf24;
            color: #000;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-800);
            border-radius: var(--radius-xl);
            padding: 20px;
        }

        .sidebar-title {
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .top-choices-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .top-choice-item {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 10px;
            font-size: 13px;
            color: #fbbf24;
            font-weight: 600;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: var(--color-neutral-400);
        }

        .stats-value {
            color: white;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .add-proposal-form {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-800);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 30px;
        }

        .form-group-voting {
            margin-bottom: 15px;
        }

        .form-group-voting label {
            display: block;
            color: var(--color-neutral-300);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-group-voting input,
        .form-group-voting textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-neutral-700);
            border-radius: 6px;
            color: white;
            font-family: inherit;
            font-size: 13px;
        }

        .form-group-voting textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group-voting input:focus,
        .form-group-voting textarea:focus {
            outline: none;
            border-color: var(--color-primary-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .add-proposal-btn,
        .save-votes-btn {
            width: 100%;
            padding: 12px;
            background: var(--color-primary-purple);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .add-proposal-btn:hover,
        .save-votes-btn:hover {
            background: #7c3aed;
        }

        .add-proposal-btn:disabled,
        .save-votes-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback-message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
            display: none;
        }

        .feedback-message.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .feedback-message.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-neutral-400);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--color-primary-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-upload-area {
            border: 2px dashed var(--color-neutral-700);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary-purple);
            background: rgba(139, 92, 246, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--color-primary-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .upload-icon {
            font-size: 24px;
            color: var(--color-neutral-500);
            margin-bottom: 8px;
        }

        .upload-text {
            color: var(--color-neutral-400);
            font-size: 13px;
        }

        .selected-file {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 4px;
            color: #10b981;
            font-size: 12px;
        }

        .top-choices-counter {
            font-size: 12px;
            color: var(--color-neutral-400);
            margin-bottom: 8px;
        }

        @media (max-width: 1024px) {
            .proposals-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .voting-container {
                padding: 10px;
            }

            .voting-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                padding: 10px 16px;
                font-size: 13px;
            }

            .voting-controls {
                flex-direction: column;
                gap: 8px;
            }

            .vote-btn {
                font-size: 11px;
                padding: 8px;
            }

            .top-choice-btn {
                width: 100%;
                height: 36px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // Firebase Configuration
        // ============================================
        
        // TODO: Replace with your actual Firebase config
        // Create a Firebase project at https://console.firebase.google.com
        const firebaseConfig = {
            apiKey: "demo-api-key",
            authDomain: "demo-project.firebaseapp.com",
            projectId: "demo-project-id",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // Global State
        // ============================================
        
        let currentUser = null;
        let currentCategory = 'azienda';
        let allProposals = new Map(); // category -> proposals
        let userVotes = new Map();
        let topChoices = new Map(); // category -> top choices
        let charts = new Map();
        let unsubscribeProposals = null;

        // User management
        const users = [
            { email: 'leo@voting.local', displayName: 'Leo' },
            { email: 'enri@voting.local', displayName: 'Enri' },
            { email: 'fane@voting.local', displayName: 'Fane' },
            { email: 'digio@voting.local', displayName: 'Digio' },
            { email: 'vince@voting.local', displayName: 'Vince' },
            { email: 'abu@voting.local', displayName: 'Abu' }
        ];

        const categories = [
            { key: 'azienda', name: 'Azienda' },
            { key: 'prodotti', name: 'Prodotti' },
            { key: 'ai', name: 'AI' }
        ];

        // ============================================
        // Authentication Functions
        // ============================================

        async function login(email, password) {
            try {
                showLoading(true);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                showFeedback('Login effettuato con successo!', 'success');
                return true;
            } catch (error) {
                console.error('Login error:', error);
                showFeedback('Errore durante il login: ' + error.message, 'error');
                return false;
            } finally {
                showLoading(false);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                userVotes.clear();
                topChoices.clear();
                if (unsubscribeProposals) {
                    unsubscribeProposals();
                }
                showFeedback('Logout effettuato con successo', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showFeedback('Errore durante il logout', 'error');
            }
        }

        function initializeAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showVotingInterface();
                    loadUserData();
                    subscribeToProposals();
                } else {
                    currentUser = null;
                    showLoginInterface();
                }
            });
        }

        // ============================================
        // Firestore Functions
        // ============================================

        function saveVote(proposalId, vote, isTopChoice = false) {
            if (!currentUser) return;

            const voteData = {
                userId: currentUser.email,
                proposalId: proposalId,
                category: currentCategory,
                vote: vote,
                isTopChoice: isTopChoice,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            return db.collection('votes').doc(`${currentUser.email}_${proposalId}`).set(voteData, { merge: true });
        }

        function saveTopChoices() {
            if (!currentUser) return Promise.resolve();

            const choices = topChoices.get(currentCategory) || [];
            const topChoicesData = {
                userId: currentUser.email,
                category: currentCategory,
                choices: choices,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            return db.collection('topChoices').doc(`${currentUser.email}_${currentCategory}`).set(topChoicesData);
        }

        function loadUserVotes() {
            if (!currentUser) return Promise.resolve();

            return db.collection('votes')
                .where('userId', '==', currentUser.email)
                .get()
                .then((snapshot) => {
                    userVotes.clear();
                    snapshot.forEach((doc) => {
                        const vote = doc.data();
                        userVotes.set(vote.proposalId, vote);
                    });
                });
        }

        function loadTopChoices() {
            if (!currentUser) return Promise.resolve();

            return db.collection('topChoices')
                .where('userId', '==', currentUser.email)
                .get()
                .then((snapshot) => {
                    topChoices.clear();
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        topChoices.set(data.category, data.choices || []);
                    });
                });
        }

        function subscribeToProposals() {
            if (unsubscribeProposals) {
                unsubscribeProposals();
            }

            unsubscribeProposals = db.collection('proposals')
                .where('category', '==', currentCategory)
                .onSnapshot(async (snapshot) => {
                    const newProposals = [];
                    snapshot.forEach((doc) => {
                        const proposal = { id: doc.id, ...doc.data() };
                        newProposals.push(proposal);
                    });

                    // Calculate scores for each proposal
                    await calculateProposalScores(newProposals);
                    
                    // Sort by score (descending)
                    newProposals.sort((a, b) => (b.score || 0) - (a.score || 0));
                    
                    // Add new flag and set score
                    newProposals.forEach(proposal => {
                        proposal.score = proposal.score || 0;
                        proposal.isNew = isNewProposal(proposal.createdAt);
                    });

                    allProposals.set(currentCategory, newProposals);
                    renderProposals();
                    updateStats();
                });
        }

        async function calculateProposalScores(proposals) {
            // For each proposal, calculate total score from all votes
            for (const proposal of proposals) {
                const votesSnapshot = await db.collection('votes')
                    .where('proposalId', '==', proposal.id)
                    .get();

                let totalScore = 0;
                votesSnapshot.forEach((doc) => {
                    const vote = doc.data();
                    const isTopChoice = vote.isTopChoice || false;
                    const voteValue = vote.vote;
                    
                    if (voteValue === 'yes') {
                        totalScore += isTopChoice ? 3 : 1;
                    } else if (voteValue === 'no') {
                        totalScore += isTopChoice ? -3 : -1;
                    }
                    // 'ignore' adds 0 points
                });

                proposal.totalScore = totalScore;
                proposal.score = totalScore;
                
                // Update proposal in Firestore
                await db.collection('proposals').doc(proposal.id).update({
                    totalScore: totalScore,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        function isNewProposal(createdAt) {
            if (!createdAt) return false;
            const now = new Date();
            const created = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
            const diffHours = (now - created) / (1000 * 60 * 60);
            return diffHours < 24;
        }

        async function addProposal(name, description, imageFile) {
            if (!currentUser) return Promise.reject('User not authenticated');

            let imageUrl = null;
            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgBB(imageFile);
                } catch (error) {
                    console.error('Image upload failed:', error);
                    // Continue without image
                }
            }

            const proposalData = {
                category: currentCategory,
                name: name,
                description: description,
                imageUrl: imageUrl,
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                totalScore: 0
            };

            return db.collection('proposals').add(proposalData);
        }

        async function uploadImageToImgBB(file) {
            if (!file) return null;

            try {
                // For demo purposes, return a placeholder
                // In real implementation, you would use ImgBB API
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('https://api.imgbb.com/1/upload?key=demo-key', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.data.display_url;
                }
                throw new Error('Upload failed');
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        // ============================================
        // UI Functions
        // ============================================

        function showLoginInterface() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('voting-container').style.display = 'none';
        }

        function showVotingInterface() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('voting-container').style.display = 'block';
            
            // Update user info
            document.getElementById('user-display-name').textContent = currentUser.email.split('@')[0];
            document.getElementById('user-email').textContent = currentUser.email;
        }

        function showFeedback(message, type) {
            const feedbackEl = document.getElementById('feedback-message');
            feedbackEl.textContent = message;
            feedbackEl.className = `feedback-message ${type}`;
            
            setTimeout(() => {
                feedbackEl.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            const loadingEls = document.querySelectorAll('.loading');
            loadingEls.forEach(el => {
                el.style.display = show ? 'block' : 'none';
            });

            const buttons = document.querySelectorAll('.login-btn, .add-proposal-btn, .save-votes-btn');
            buttons.forEach(btn => {
                btn.disabled = show;
            });
        }

        function switchCategory(category) {
            currentCategory = category;
            
            // Update tab active state
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`content-${category}`).classList.add('active');

            // Subscribe to proposals for new category
            subscribeToProposals();
        }

        function loadUserData() {
            if (!currentUser) return;

            loadUserVotes();
            loadTopChoices();
        }

        function renderProposals() {
            const proposals = allProposals.get(currentCategory) || [];
            const container = document.getElementById(`proposals-list-${currentCategory}`);
            if (!container) return;

            if (!proposals.length) {
                container.innerHTML = '<div class="loading">Nessuna proposta disponibile</div>';
                return;
            }

            container.innerHTML = proposals.map(proposal => {
                const userVote = userVotes.get(proposal.id);
                const categoryTopChoices = topChoices.get(currentCategory) || [];
                const isTopChoice = categoryTopChoices.includes(proposal.id);
                const isNew = proposal.isNew;

                return `
                    <div class="proposal-card">
                        <div class="proposal-header">
                            <div class="proposal-title">
                                ${proposal.name}
                                ${isNew ? '<span class="badge-new">NUOVO</span>' : ''}
                            </div>
                            <div class="proposal-score ${proposal.score < 0 ? 'negative' : ''}">
                                ${proposal.score >= 0 ? '+' : ''}${proposal.score}
                            </div>
                        </div>
                        
                        <div class="proposal-meta">
                            Proposta da ${proposal.createdBy} ‚Ä¢ ${formatDate(proposal.createdAt)}
                        </div>
                        
                        <div class="proposal-desc">
                            ${proposal.description}
                        </div>
                        
                        ${proposal.imageUrl ? `
                            <img src="${proposal.imageUrl}" alt="${proposal.name}" class="proposal-image">
                        ` : ''}
                        
                        <div class="voting-controls">
                            <button class="vote-btn ${userVote?.vote === 'yes' ? 'vote-yes' : ''}" 
                                    onclick="castVote('${proposal.id}', 'yes')">
                                ‚úì Si
                            </button>
                            <button class="vote-btn ${userVote?.vote === 'no' ? 'vote-no' : ''}" 
                                    onclick="castVote('${proposal.id}', 'no')">
                                ‚úó No
                            </button>
                            <button class="vote-btn ${userVote?.vote === 'ignore' ? 'vote-ignore' : ''}" 
                                    onclick="castVote('${proposal.id}', 'ignore')">
                                ‚Äî Ignora
                            </button>
                            <button class="top-choice-btn ${isTopChoice ? 'active' : ''}" 
                                    onclick="toggleTopChoice('${proposal.id}')"
                                    ${categoryTopChoices.length >= 3 && !isTopChoice ? 'disabled' : ''}
                                    title="${isTopChoice ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti'}">
                                ‚òÖ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const proposals = allProposals.get(currentCategory) || [];
            const totalProposals = proposals.length;
            const avgScore = proposals.length > 0 ? 
                (proposals.reduce((sum, p) => sum + (p.score || 0), 0) / proposals.length).toFixed(1) : 0;
            const bestProposal = proposals.length > 0 ? proposals[0] : null;

            // Update stats in current category
            const totalEl = document.getElementById(`total-proposals-${currentCategory}`);
            const avgEl = document.getElementById(`avg-score-${currentCategory}`);
            const bestEl = document.getElementById(`best-proposal-${currentCategory}`);
            
            if (totalEl) totalEl.textContent = totalProposals;
            if (avgEl) avgEl.textContent = avgScore;
            if (bestEl) bestEl.textContent = bestProposal ? bestProposal.name : 'N/A';

            updateTopChoicesList();
            updateChart();
        }

        function updateTopChoicesList() {
            const choices = topChoices.get(currentCategory) || [];
            const proposals = allProposals.get(currentCategory) || [];
            const topChoiceProposals = proposals.filter(p => choices.includes(p.id));
            
            const container = document.getElementById(`top-choices-list-${currentCategory}`);
            if (!container) return;
            
            container.innerHTML = topChoiceProposals.map(proposal => `
                <div class="top-choice-item">
                    ${proposal.name}
                </div>
            `).join('') || '<div style="color: var(--color-neutral-500); font-size: 12px;">Nessuna scelta top</div>';

            const counterEl = document.getElementById(`top-choices-counter-${currentCategory}`);
            if (counterEl) {
                counterEl.textContent = `Top choices: ${choices.length}/3`;
            }
        }

        function updateChart() {
            const proposals = allProposals.get(currentCategory) || [];
            const top5 = proposals.slice(0, 5);
            
            // Destroy existing chart for this category
            if (charts.has(currentCategory)) {
                charts.get(currentCategory).destroy();
            }

            const ctx = document.getElementById(`score-chart-${currentCategory}`);
            if (!ctx || top5.length === 0) return;

            const labels = top5.map(p => p.name);
            const data = top5.map(p => p.score || 0);
            const colors = data.map(score => score >= 0 ? '#10b981' : '#ef4444');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Punteggio',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 45
                            }
                        }
                    }
                }
            });

            charts.set(currentCategory, chart);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Data sconosciuta';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('it-IT', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ============================================
        // Event Handlers
        // ============================================

        async function castVote(proposalId, voteType) {
            if (!currentUser) return;

            try {
                const choices = topChoices.get(currentCategory) || [];
                const isTopChoice = choices.includes(proposalId);
                await saveVote(proposalId, voteType, isTopChoice);
                showFeedback('Voto registrato!', 'success');
                
                // Reload user data to reflect changes
                await loadUserVotes();
            } catch (error) {
                console.error('Vote error:', error);
                showFeedback('Errore nel registrare il voto', 'error');
            }
        }

        async function toggleTopChoice(proposalId) {
            if (!currentUser) return;

            const choices = topChoices.get(currentCategory) || [];
            const index = choices.indexOf(proposalId);
            
            if (index > -1) {
                choices.splice(index, 1);
            } else {
                if (choices.length >= 3) {
                    showFeedback('Puoi selezionare massimo 3 proposte top', 'error');
                    return;
                }
                choices.push(proposalId);
            }

            topChoices.set(currentCategory, choices);

            try {
                await saveTopChoices();
                const userVote = userVotes.get(proposalId);
                await saveVote(proposalId, userVote?.vote || 'ignore', choices.includes(proposalId));
                showFeedback('Preferenze aggiornate!', 'success');
                await loadUserVotes();
                renderProposals();
            } catch (error) {
                console.error('Top choice error:', error);
                showFeedback('Errore nell\'aggiornare le preferenze', 'error');
            }
        }

        async function handleAddProposal(event) {
            event.preventDefault();
            
            if (!currentUser) return;

            const form = event.target;
            const name = form.name.value.trim();
            const description = form.description.value.trim();
            const imageFile = form.image.files[0];

            if (!name || !description) {
                showFeedback('Nome e descrizione sono obbligatori', 'error');
                return;
            }

            try {
                showLoading(true);
                
                let imageUrl = null;
                if (imageFile) {
                    try {
                        imageUrl = await uploadImageToImgBB(imageFile);
                    } catch (error) {
                        console.warn('Image upload failed, continuing without image');
                    }
                }

                await addProposal(name, description, imageUrl);
                showFeedback('Proposta aggiunta con successo!', 'success');
                
                form.reset();
                const selectedFileEl = document.getElementById(`selected-file-${currentCategory}`);
                if (selectedFileEl) {
                    selectedFileEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Add proposal error:', error);
                showFeedback('Errore nell\'aggiungere la proposta', 'error');
            } finally {
                showLoading(false);
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;

            if (!email || !password) {
                showFeedback('Email e password sono richieste', 'error');
                return;
            }

            login(email, password);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const selectedFileEl = document.getElementById(`selected-file-${currentCategory}`);
            
            if (file) {
                selectedFileEl.textContent = `File selezionato: ${file.name}`;
                selectedFileEl.style.display = 'block';
            } else {
                selectedFileEl.style.display = 'none';
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const inputId = `image-input-${currentCategory}`;
                document.getElementById(inputId).files = files;
                handleFileSelect({ target: { files: files } });
            }
        }

        // ============================================
        // Event Listeners
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchCategory(tab.dataset.category);
                });
            });

            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Add proposal forms for each category
            document.querySelectorAll('[id^="add-proposal-form"]').forEach(form => {
                form.addEventListener('submit', handleAddProposal);
            });

            // File upload inputs
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', handleFileSelect);
            });

            // File upload areas
            document.querySelectorAll('.file-upload-area').forEach(area => {
                area.addEventListener('dragover', handleDragOver);
                area.addEventListener('dragleave', handleDragLeave);
                area.addEventListener('drop', handleDrop);
            });

            // Set default active tab
            switchCategory('azienda');
        });
    </script>
</head>

<body>
    <!-- Login Interface -->
    <div id="login-container" class="login-container">
        <form id="login-form" class="login-form">
            <h1>üîê Accedi alla Piattaforma</h1>
            <p>Vota per i nomi della nostra azienda, prodotti e AI</p>
            
            <div id="feedback-message" class="feedback-message"></div>
            
            <div class="form-group">
                <label for="email">Email</label>
                <select id="email" required>
                    <option value="">Seleziona utente</option>
                    <option value="leo@voting.local">leo@voting.local</option>
                    <option value="enri@voting.local">enri@voting.local</option>
                    <option value="fane@voting.local">fane@voting.local</option>
                    <option value="digio@voting.local">digio@voting.local</option>
                    <option value="vince@voting.local">vince@voting.local</option>
                    <option value="abu@voting.local">abu@voting.local</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" value="tvrvlli2025" required>
            </div>
            
            <button type="submit" class="login-btn">Accedi</button>
            
            <div class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Accesso in corso...</p>
            </div>
        </form>
    </div>

    <!-- Voting Interface -->
    <div id="voting-container" class="voting-container" style="display: none;">
        <div class="voting-header">
            <div class="voting-user-info">
                <div class="voting-user-badge">
                    <span id="user-display-name">User</span>
                </div>
                <div>
                    <div style="color: white; font-weight: 600;" id="user-email"></div>
                    <div style="color: var(--color-neutral-400); font-size: 12px;">Piattaforma di Votazione</div>
                </div>
            </div>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </div>

        <div class="tabs">
            <button class="tab active" data-category="azienda">üè¢ Azienda</button>
            <button class="tab" data-category="prodotti">üì¶ Prodotti</button>
            <button class="tab" data-category="ai">ü§ñ AI</button>
        </div>

        <div class="tab-content active" id="content-azienda">
            <div class="proposals-grid">
                <div>
                    <div class="add-proposal-form">
                        <h3 style="color: white; margin-bottom: 15px; font-size: 16px;">‚ûï Aggiungi Nuova Proposta</h3>
                        <form id="add-proposal-form-azienda">
                            <div class="form-group-voting">
                                <label for="proposal-name-azienda">Nome Proposta</label>
                                <input type="text" id="proposal-name-azienda" name="name" required 
                                       placeholder="Inserisci il nome della proposta">
                            </div>
                            
                            <div class="form-group-voting">
                                <label for="proposal-desc-azienda">Descrizione</label>
                                <textarea id="proposal-desc-azienda" name="description" required 
                                          placeholder="Descrivi la tua proposta..."></textarea>
                            </div>
                            
                            <div class="form-group-voting">
                                <label>Immagine (facoltativa)</label>
                                <div class="file-upload-area" onclick="document.getElementById('image-input-azienda').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">Clicca o trascina un file qui</div>
                                </div>
                                <input type="file" id="image-input-azienda" name="image" accept="image/*" style="display: none;">
                                <div id="selected-file-azienda" class="selected-file" style="display: none;"></div>
                            </div>
                            
                            <button type="submit" class="add-proposal-btn">üöÄ Proponi</button>
                            <div class="loading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Creazione proposta...</p>
                            </div>
                        </form>
                    </div>

                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Caricamento proposte...</p>
                    </div>

                    <div id="proposals-list-azienda" class="proposals-list">
                        <!-- Proposals will be loaded here -->
                    </div>
                </div>

                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">‚≠ê I tuoi Top 3</div>
                        <div class="top-choices-counter" id="top-choices-counter-azienda">Top choices: 0/3</div>
                        <div id="top-choices-list-azienda" class="top-choices-list">
                            <!-- Top choices will be loaded here -->
                        </div>
                        <button class="save-votes-btn" onclick="saveTopChoices()">üíæ Salva Preferenze</button>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìä Statistiche</div>
                        <div class="stats-item">
                            <span class="stats-label">Totale Proposte:</span>
                            <span class="stats-value" id="total-proposals-azienda">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Punteggio Medio:</span>
                            <span class="stats-value" id="avg-score-azienda">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Miglior Proposta:</span>
                            <span class="stats-value" id="best-proposal-azienda">N/A</span>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìà Top 5 Punteggi</div>
                        <div class="chart-container">
                            <canvas id="score-chart-azienda"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="content-prodotti">
            <div class="proposals-grid">
                <div>
                    <div class="add-proposal-form">
                        <h3 style="color: white; margin-bottom: 15px; font-size: 16px;">‚ûï Aggiungi Nuova Proposta</h3>
                        <form id="add-proposal-form-prodotti">
                            <div class="form-group-voting">
                                <label for="proposal-name-prodotti">Nome Proposta</label>
                                <input type="text" id="proposal-name-prodotti" name="name" required 
                                       placeholder="Inserisci il nome della proposta">
                            </div>
                            
                            <div class="form-group-voting">
                                <label for="proposal-desc-prodotti">Descrizione</label>
                                <textarea id="proposal-desc-prodotti" name="description" required 
                                          placeholder="Descrivi la tua proposta..."></textarea>
                            </div>
                            
                            <div class="form-group-voting">
                                <label>Immagine (facoltativa)</label>
                                <div class="file-upload-area" onclick="document.getElementById('image-input-prodotti').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">Clicca o trascina un file qui</div>
                                </div>
                                <input type="file" id="image-input-prodotti" name="image" accept="image/*" style="display: none;">
                                <div id="selected-file-prodotti" class="selected-file" style="display: none;"></div>
                            </div>
                            
                            <button type="submit" class="add-proposal-btn">üöÄ Proponi</button>
                        </form>
                    </div>

                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Caricamento proposte...</p>
                    </div>

                    <div id="proposals-list-prodotti" class="proposals-list">
                        <!-- Proposals will be loaded here -->
                    </div>
                </div>

                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">‚≠ê I tuoi Top 3</div>
                        <div class="top-choices-counter" id="top-choices-counter-prodotti">Top choices: 0/3</div>
                        <div id="top-choices-list-prodotti" class="top-choices-list">
                            <!-- Top choices will be loaded here -->
                        </div>
                        <button class="save-votes-btn" onclick="saveTopChoices()">üíæ Salva Preferenze</button>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìä Statistiche</div>
                        <div class="stats-item">
                            <span class="stats-label">Totale Proposte:</span>
                            <span class="stats-value" id="total-proposals-prodotti">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Punteggio Medio:</span>
                            <span class="stats-value" id="avg-score-prodotti">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Miglior Proposta:</span>
                            <span class="stats-value" id="best-proposal-prodotti">N/A</span>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìà Top 5 Punteggi</div>
                        <div class="chart-container">
                            <canvas id="score-chart-prodotti"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="content-ai">
            <div class="proposals-grid">
                <div>
                    <div class="add-proposal-form">
                        <h3 style="color: white; margin-bottom: 15px; font-size: 16px;">‚ûï Aggiungi Nuova Proposta</h3>
                        <form id="add-proposal-form-ai">
                            <div class="form-group-voting">
                                <label for="proposal-name-ai">Nome Proposta</label>
                                <input type="text" id="proposal-name-ai" name="name" required 
                                       placeholder="Inserisci il nome della proposta">
                            </div>
                            
                            <div class="form-group-voting">
                                <label for="proposal-desc-ai">Descrizione</label>
                                <textarea id="proposal-desc-ai" name="description" required 
                                          placeholder="Descrivi la tua proposta..."></textarea>
                            </div>
                            
                            <div class="form-group-voting">
                                <label>Immagine (facoltativa)</label>
                                <div class="file-upload-area" onclick="document.getElementById('image-input-ai').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">Clicca o trascina un file qui</div>
                                </div>
                                <input type="file" id="image-input-ai" name="image" accept="image/*" style="display: none;">
                                <div id="selected-file-ai" class="selected-file" style="display: none;"></div>
                            </div>
                            
                            <button type="submit" class="add-proposal-btn">üöÄ Proponi</button>
                        </form>
                    </div>

                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Caricamento proposte...</p>
                    </div>

                    <div id="proposals-list-ai" class="proposals-list">
                        <!-- Proposals will be loaded here -->
                    </div>
                </div>

                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">‚≠ê I tuoi Top 3</div>
                        <div class="top-choices-counter" id="top-choices-counter-ai">Top choices: 0/3</div>
                        <div id="top-choices-list-ai" class="top-choices-list">
                            <!-- Top choices will be loaded here -->
                        </div>
                        <button class="save-votes-btn" onclick="saveTopChoices()">üíæ Salva Preferenze</button>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìä Statistiche</div>
                        <div class="stats-item">
                            <span class="stats-label">Totale Proposte:</span>
                            <span class="stats-value" id="total-proposals-ai">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Punteggio Medio:</span>
                            <span class="stats-value" id="avg-score-ai">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Miglior Proposta:</span>
                            <span class="stats-value" id="best-proposal-ai">N/A</span>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">üìà Top 5 Punteggi</div>
                        <div class="chart-container">
                            <canvas id="score-chart-ai"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>